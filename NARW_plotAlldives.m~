% list of deployments
% tags = {'eg05_219a'; 'eg05_224a'; 'eg05_230a'; 'eg05_231a';'eg05_231b';'eg05_232a';'eg05_235a';
%    'eg02_213b';'eg02_213g';'eg02_220f';'eg02_221d';'eg02_222c';'eg02_229e';'eg02_232d';
%    'eg02_233a';'eg02_236c'};%'eg05_218c'};
close all
% tags is deployment name, time of tag on, cue of tag off
load('NARW_foraging_tags')

for i = 1:length(tags)
    tag = tags{i};
    loadprh(tag);
    
    % cut depth to time of tag off
    %p = p(1:tags{i,3});
    t = (1:length(p))/fs/3600; % compute time vector
    
    % compute amount of time within 10m of surface
    [tags{i,4},tags{i,5}] = findsurftime(p,fs,10);
    figure(5), subplot(length(tags),1,i), hold on
    histogram(tags{i,5}/60,0:1:80), xlabel('Continuous Surface Time (min)')
    
    %figure(6), hold on
    %cdfplot(tags{i,5}/60)
    
    
    % how many dives > 50 m
    T = finddives(p,fs,50,1);
    % mean(T(:,2)-T(:,1))/60
    % pause
    
    % plot by time of day
    figure(100), subplot(length(tags),1,i), hold on, box on
    UTC = tags{i,2}(4:end);
    hh=plot((UTC(1)+UTC(2)/60+UTC(3)/3600)+[1:length(p)]/fs/3600,-p,'k','LineWidth',1);
    ylim([-200 10]), xlim([9 24])
    
    figure(101), subplot(length(tags),1,i), hold on, box on
    plot(t,-p,'k'), ylim([-200 10]), xlim([0 11.7]) % xmax of tags
    
    NARW_plotalldens
    NARW_divepauseplot
    
    for k = 1:size(T,1) % all dives on a tag
        if isempty(dive(k).stops) == 0
            figure(11), subplot(2,2,1), hold on
            plot(ddur(k)/60,size(dive(k).stops,1),'o')
            xlabel('Dive Duration (min)'), ylabel('Number of fluking bouts')
            subplot(2,2,2), hold on
            errorbar(ddur(k)/60,mean([dive(k).clearingtime]),std([dive(k).clearingtime]),'o')
            xlabel('Dive Duration (min)'), ylabel('Duration of fluking bouts (sec)')
            subplot(2,2,3), hold on
            plot(ddur(k)/60,tags{i,6},'o')
            xlabel('Dive Duration (min)'), ylabel('Age (years)')
            subplot(2,2,4), hold on
            errorbar(tags{i,6},mean([dive(k).vperblock]),std([dive(k).vperblock]),'o')
            xlabel('Age (years)'), ylabel('Volume filtered per fluking interval (m^3)')
        end
        
        
        if isempty(dive(k).btm) == 1 & tag ~= 'eg05_210b' 
            % descent speed
            phase_speed(k,1) = nanmean(dive(k).flowEst(round((T(k,1)+5:T(k,4))-T(k,1)+1)));
            % ascent speed
            phase_speed(k,2) = nanmean(dive(k).flowEst(round((T(k,4):T(k,2)-10)-T(k,1))));
        end
        
        
        if dive(k).btm > 1
            % descent speed
            phase_speed(k,1) = nanmean(dive(k).flowEst(5:dive(k).btm(1)));
            % ascent speed
            if find(isinf(dive(k).flowEst),1,'last') < 10
                phase_speed(k,2) = nanmean(dive(k).flowEst(dive(k).btm(end):end));
            else
                phase_speed(k,2) = nanmean(dive(k).flowEst(dive(k).btm(end):find(isinf(dive(k).flowEst(5:end)) == 1,1,'first')));
            end
            % bottom speed
            phase_speed(k,3) = nanmean(dive(k).flowEst(dive(k).btm));
        end
    end
end

if i < 10
    keep tags i % to remove carry-over of variables
end


figure(100), xlabel('Local Time'), adjustfigurefont
set(gcf,'position',[323 61 512 612],'paperpositionmode','auto')
print('NARW_alldives_TOD.png','-dpng','-r300')

figure(101), xlabel('Hours since tag on'), adjustfigurefont
set(gcf,'position',[323 61 512 612],'paperpositionmode','auto')
print('NARW_alldives_TSTO.png','-dpng','-r300')

% max(vertcat(tags{:,5}))/60 = longest surface time above 10 m

